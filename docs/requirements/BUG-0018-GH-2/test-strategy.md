# Test Strategy: BUG-0018-GH-2 -- Backlog Picker Pattern Mismatch

**Phase**: 05-test-strategy
**Created**: 2026-02-16
**Bug**: BUG-0018 -- Backlog picker pattern mismatch after BACKLOG.md restructure
**Requirements**: 5 FRs, 3 NFRs, 19 ACs

---

## 1. Existing Infrastructure

### Framework
- **Test runner**: Node.js built-in `node:test` + `node:assert/strict` (Node 18+)
- **CJS stream**: `src/claude/hooks/tests/*.test.cjs` -- run via `npm run test:hooks`
- **ESM stream**: `lib/*.test.js` -- run via `npm test`
- **Coverage tool**: None project-wide; constitution targets >=80% unit, >=70% integration
- **Current test count**: 555 tests baseline (302 ESM + 253 CJS)

### Existing Patterns
- CJS tests use `hook-test-utils.cjs` for `setupTestEnv`, `cleanupTestEnv`, `writeState`, `readState`
- Tests copy source modules to temp directories as `.cjs` files to avoid ESM/CJS conflicts
- Test files follow naming: `test-{module-name}.test.cjs` (CJS) or `{module}.test.js` (ESM)
- Test structure: `describe()` blocks with `before`/`after` hooks for setup/teardown

### Existing Backlog Picker Tests
- **None found**. The requirements spec referenced 5 backlog test files (`backlog-*.test.cjs`) but these do not exist. The trace analysis confirmed this (Hypothesis 3).
- The backlog picker is defined in markdown agent instructions (`00-sdlc-orchestrator.md`), not executable code.
- No runtime-testable functions exist for the picker pattern matching.

### Gap Assessment
- **Critical gap**: Zero test coverage for backlog picker suffix handling
- **Nature of the fix**: Markdown instruction changes (not code changes)
- **Test approach**: Verify markdown content contains correct suffix-stripping instructions

---

## 2. Test Approach

### Nature of the Change

This bug fix modifies **markdown agent instructions**, not executable code. The backlog picker is a set of natural-language instructions in `00-sdlc-orchestrator.md` that guide the LLM agent. There are no functions or modules to unit test in the traditional sense.

The appropriate test types for this fix are:

| Test Type | Applicable | Rationale |
|-----------|-----------|-----------|
| **Prompt content verification** | Yes | Verify markdown files contain required instructions (suffix stripping, format handling) |
| **Pattern validation** | Yes | Verify the documented patterns match expected BACKLOG.md formats |
| **Regression tests** | Yes | Verify existing orchestrator test content is not broken |
| **Integration (E2E)** | No | Would require full agent execution; out of scope for a markdown fix |
| **Performance** | No | Markdown parsing latency is negligible (NFR-3 satisfied by nature of change) |
| **Security** | No | No security surface area in display text stripping |

### Test Strategy Summary

1. **Content verification tests** (CJS stream): New test file `test-backlog-picker-content.test.cjs` that reads `00-sdlc-orchestrator.md` and verifies the BACKLOG PICKER section contains:
   - Suffix stripping instructions for `-> [requirements](...)` and `-> [design](...)`
   - Both old format and new format handling
   - Jira metadata parsing preservation
   - Backward compatibility instructions

2. **Format pattern tests** (CJS stream): Within the same test file, verify that example patterns documented in the orchestrator match expected BACKLOG.md line formats using regex validation.

3. **isdlc.md content tests** (CJS stream): Verify `isdlc.md` documents the `start` action reuse mechanism (FR-5).

4. **Cross-reference tests**: Verify the suffix generated by Phase A (`isdlc.md` line 257) matches the suffix stripped by the picker (`00-sdlc-orchestrator.md`).

---

## 3. Test Organization

### New Test File

```
src/claude/hooks/tests/test-backlog-picker-content.test.cjs
```

This follows the existing CJS test naming convention (`test-{module}.test.cjs`) and will be picked up by `npm run test:hooks`.

### Test Categories

| Category | Test Count | Priority |
|----------|-----------|----------|
| TC-FR1: Suffix stripping instructions | 4 | P0 |
| TC-FR2: Format variant handling | 6 | P0 |
| TC-FR3: Jira metadata preservation | 3 | P1 |
| TC-FR4: Test coverage verification | 4 | P1 |
| TC-FR5: Start action documentation | 3 | P2 |
| TC-NFR1: Backward compatibility | 2 | P1 |
| TC-NFR2: No regression | 2 | P1 |
| TC-CROSS: Cross-reference consistency | 2 | P0 |
| **Total** | **26** | |

---

## 4. Coverage Targets

| Metric | Target | Rationale |
|--------|--------|-----------|
| Requirement coverage | 100% (all 5 FRs, 3 NFRs) | Constitutional Article VII |
| AC coverage | 100% (all 19 ACs) | Constitutional Article II |
| Test pass rate | 100% | All tests must pass before GATE-05 |
| Regression baseline | >= 555 tests | Constitutional Article II regression threshold |

**Note**: Traditional code coverage metrics (line/branch/statement) do not apply because the fix targets markdown files. Coverage is measured by requirement and acceptance criteria mapping instead.

---

## 5. Test Data Plan

### BACKLOG.md Format Variants

The tests validate that the orchestrator markdown contains instructions to handle these formats:

| Format | Example | Category |
|--------|---------|----------|
| Old format (no suffix) | `- 3.1 [ ] Parallel workflow support` | Valid, no stripping needed |
| New format (requirements link) | `- 3.1 [ ] Parallel workflow support -> [requirements](docs/requirements/3.1-parallel-workflow-support/)` | Valid, strip suffix |
| New format (design link) | `- 3.1 [ ] API design -> [design](docs/design/3.1-api-design/)` | Valid, strip suffix |
| Checked item | `- 3.1 [x] ~~Completed item~~` | Valid, excluded from picker |
| Jira item with suffix | `- 3.1 [ ] JIRA item -> [requirements](...)` with `**Jira:** PROJ-123` sub-bullet | Valid, strip suffix + show Jira tag |
| Section header | `### 3. Parallel Workflows` | Not an item, skip |
| Sub-bullet metadata | `  - **Priority:** High` | Not an item, skip |
| Empty title | `- 3.1 [ ] ` | Edge case |
| No BACKLOG.md | File does not exist | Backward compat fallback |

### Orchestrator Content Assertions

For each test case, the test reads the orchestrator markdown file and checks for specific instruction text using string matching or regex patterns. No runtime execution is needed.

---

## 6. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Markdown instructions are ambiguous | Medium | Medium | Tests verify specific phrases exist, not just generic mentions |
| Fix mode scan (line 312) missed | Low | High | Separate test cases for feature mode and fix mode sections |
| Phase A format diverges from picker | Low | High | Cross-reference test validates consistency between isdlc.md and orchestrator |
| Test file not included in test:hooks | Low | Low | Verify file matches `*.test.cjs` glob in npm script |

---

## 7. Test Commands

All tests run within the existing CJS test stream:

```bash
# Run just the new backlog picker content tests
node --test src/claude/hooks/tests/test-backlog-picker-content.test.cjs

# Run all CJS hook tests (includes new tests)
npm run test:hooks

# Run full test suite (ESM + CJS)
npm run test:all
```

---

## 8. Constitutional Compliance

| Article | Requirement | Status |
|---------|------------|--------|
| Article II (Test-First) | Tests designed before implementation | Satisfied -- this strategy precedes Phase 06 |
| Article VII (Traceability) | 100% requirement-to-test mapping | Satisfied -- traceability matrix covers all 5 FRs + 3 NFRs |
| Article IX (Gate Integrity) | All artifacts complete for GATE-05 | Satisfied -- strategy, cases, matrix, data plan all produced |
| Article XI (Integration Testing) | Integration tests validate interactions | N/A -- fix is to markdown instructions, not component interfaces |
