# Unit Test Cases: BUG-0019-GH-1

## Overview

Unit tests for the blast-radius block handling logic. These tests validate individual functions and parsing routines that will be implemented as part of the STEP 3f enhancement.

**Test File**: `src/claude/hooks/tests/test-blast-radius-step3f.test.cjs`
**Framework**: `node:test` + `node:assert/strict`
**Pattern**: Follows existing `test-blast-radius-validator.test.cjs` conventions

---

## 1. Block Message Parsing Tests

### TC-PARSE-01: Extract file paths from single unaddressed file

**Requirement**: FR-01, AC-01.4, AC-05.2
**Priority**: P0

**Setup**:
```
Input block message (generated by formatBlockMessage):
  "BLAST RADIUS COVERAGE INCOMPLETE: 1 of 3 affected files are unaddressed.

    - src/hooks/missing.cjs (expected: MODIFY)

  Coverage: 2 covered, 0 deferred, 1 unaddressed
  ..."
```

**Steps**:
1. Call `parseBlockMessageFiles(blockMessage)` with single-file block message
2. Verify returned array contains exactly one entry
3. Verify entry has `filePath: 'src/hooks/missing.cjs'` and `changeType: 'MODIFY'`

**Expected Result**: Returns `[{ filePath: 'src/hooks/missing.cjs', changeType: 'MODIFY' }]`

---

### TC-PARSE-02: Extract file paths from multiple unaddressed files

**Requirement**: FR-01, AC-01.4, AC-05.2
**Priority**: P0

**Setup**:
```
Input block message with 3 unaddressed files:
  "BLAST RADIUS COVERAGE INCOMPLETE: 3 of 5 affected files are unaddressed.

    - src/hooks/a.cjs (expected: MODIFY)
    - src/agents/b.md (expected: CREATE)
    - src/commands/c.md (expected: DELETE)

  Coverage: 2 covered, 0 deferred, 3 unaddressed
  ..."
```

**Steps**:
1. Call `parseBlockMessageFiles(blockMessage)`
2. Verify returned array has length 3
3. Verify all three file paths are present with correct change types

**Expected Result**: Returns array with all 3 entries, each with correct filePath and changeType.

---

### TC-PARSE-03: Extract change types (MODIFY, CREATE, DELETE)

**Requirement**: FR-01, AC-05.2
**Priority**: P1

**Setup**: Block message containing one file of each change type.

**Steps**:
1. Call `parseBlockMessageFiles(blockMessage)` with mixed change types
2. Verify each file has the correct changeType value

**Expected Result**: Each entry's changeType matches the expected value (MODIFY, CREATE, DELETE).

---

### TC-PARSE-04: Handle empty block message

**Requirement**: FR-01, AC-05.2
**Priority**: P1

**Setup**: Empty string input.

**Steps**:
1. Call `parseBlockMessageFiles('')`
2. Verify returns empty array

**Expected Result**: Returns `[]`.

---

### TC-PARSE-05: Handle malformed block message

**Requirement**: FR-01, AC-05.2
**Priority**: P1

**Setup**: Block message that does not match the expected `formatBlockMessage()` pattern (e.g., random text, different hook's block message).

**Steps**:
1. Call `parseBlockMessageFiles('Some other hook blocked: reason XYZ')`
2. Verify returns empty array (graceful degradation)

**Expected Result**: Returns `[]`.

---

## 2. Task Plan Cross-Reference Tests

### TC-TASK-01: Match single unaddressed file to task entry

**Requirement**: FR-02, AC-02.2
**Priority**: P0

**Setup**:
```
unaddressedFiles: [{ filePath: 'src/hooks/a.cjs', changeType: 'MODIFY' }]

tasks.md content:
  "- [ ] T0004a -- Parse blast radius block message
   - [ ] T0004b -- Modify src/hooks/a.cjs for new validation logic
   - [ ] T0004c -- Update tests"
```

**Steps**:
1. Call `matchFilesToTasks(unaddressedFiles, tasksMdContent)`
2. Verify returned match includes T0004b for `src/hooks/a.cjs`

**Expected Result**: Returns `[{ filePath: 'src/hooks/a.cjs', taskId: 'T0004b', taskDescription: 'Modify src/hooks/a.cjs for new validation logic', status: 'pending' }]`

---

### TC-TASK-02: Match multiple unaddressed files to task entries

**Requirement**: FR-02, AC-02.2, AC-02.3
**Priority**: P0

**Setup**: Three unaddressed files with corresponding tasks in tasks.md.

**Steps**:
1. Call `matchFilesToTasks(unaddressedFiles, tasksMdContent)` with 3 files
2. Verify all 3 files have matching task entries

**Expected Result**: Returns array with 3 matched entries.

---

### TC-TASK-03: Detect unaddressed file with no matching task

**Requirement**: FR-02, AC-02.2
**Priority**: P1

**Setup**: One unaddressed file that has no corresponding task in tasks.md.

**Steps**:
1. Call `matchFilesToTasks(unaddressedFiles, tasksMdContent)` where the file is not mentioned in tasks.md
2. Verify the file is returned with `taskId: null`

**Expected Result**: Returns entry with `taskId: null`, indicating no matching task found.

---

### TC-TASK-04: Detect task marked [X] but file unaddressed (discrepancy)

**Requirement**: FR-02, AC-02.4
**Priority**: P1

**Setup**:
```
unaddressedFiles: [{ filePath: 'src/hooks/a.cjs', changeType: 'MODIFY' }]

tasks.md content:
  "- [X] T0004b -- Modify src/hooks/a.cjs for new validation logic"
```

**Steps**:
1. Call `matchFilesToTasks(unaddressedFiles, tasksMdContent)`
2. Verify the match has `status: 'completed'` and a `discrepancy: true` flag

**Expected Result**: Returns entry with `status: 'completed'` and `discrepancy: true` (task says done but file not in git diff).

---

### TC-TASK-05: Handle missing tasks.md gracefully

**Requirement**: FR-02, AC-02.1
**Priority**: P1

**Setup**: `tasksMdContent` is `null` (file does not exist).

**Steps**:
1. Call `matchFilesToTasks(unaddressedFiles, null)`
2. Verify returns array with all files having `taskId: null`

**Expected Result**: Returns entries without matches, no error thrown.

---

### TC-TASK-06: Handle empty tasks.md content

**Requirement**: FR-02, AC-02.1
**Priority**: P1

**Setup**: `tasksMdContent` is empty string.

**Steps**:
1. Call `matchFilesToTasks(unaddressedFiles, '')`
2. Verify returns array with all files having `taskId: null`

**Expected Result**: Returns entries without matches, no error thrown.

---

## 3. Deferral Validation Tests

### TC-DEF-01: Accept deferral from requirements-spec.md

**Requirement**: FR-04, AC-04.1, AC-04.2
**Priority**: P0

**Setup**:
```
requirementsSpecContent:
  "## Deferred Files

  | File | Justification |
  |------|---------------|
  | `src/agents/dev.md` | Not needed for MVP; will address in REQ-0012 |"

filePath: 'src/agents/dev.md'
```

**Steps**:
1. Call `isValidDeferral(filePath, requirementsSpecContent)`
2. Verify returns `true`

**Expected Result**: Returns `true`.

---

### TC-DEF-02: Reject deferral not in requirements-spec.md

**Requirement**: FR-04, AC-04.3
**Priority**: P0

**Setup**: requirements-spec.md has a Deferred Files section, but the file in question is NOT listed there.

**Steps**:
1. Call `isValidDeferral('src/hooks/unlisted.cjs', requirementsSpecContent)`
2. Verify returns `false`

**Expected Result**: Returns `false`.

---

### TC-DEF-03: No Deferred Files section means no valid deferrals

**Requirement**: FR-04, AC-04.1
**Priority**: P1

**Setup**: requirements-spec.md exists but has no `## Deferred Files` section.

**Steps**:
1. Call `isValidDeferral('src/any/file.cjs', requirementsSpecWithoutDeferredSection)`
2. Verify returns `false`

**Expected Result**: Returns `false`.

---

### TC-DEF-04: Malformed Deferred Files section

**Requirement**: FR-04, AC-04.1
**Priority**: P2

**Setup**: requirements-spec.md has a `## Deferred Files` heading but the table is malformed.

**Steps**:
1. Call `isValidDeferral(filePath, malformedContent)`
2. Verify returns `false` (fails safe)

**Expected Result**: Returns `false`.

---

## 4. Retry Counter Tests

### TC-RETRY-01: Initialize retry counter on first blast radius block

**Requirement**: FR-03, AC-03.4
**Priority**: P0

**Setup**: state.json has no `blast_radius_retries` field.

**Steps**:
1. Call `incrementBlastRadiusRetry(state)` for the first time
2. Verify state now has `blast_radius_retries: 1`

**Expected Result**: `state.blast_radius_retries === 1`.

---

### TC-RETRY-02: Increment retry counter on subsequent blocks

**Requirement**: FR-03, AC-03.4
**Priority**: P0

**Steps**:
1. Start with `state.blast_radius_retries = 1`
2. Call `incrementBlastRadiusRetry(state)`
3. Verify `state.blast_radius_retries === 2`

**Expected Result**: Counter incremented by 1.

---

### TC-RETRY-03: Detect max retries exceeded (3 iterations)

**Requirement**: FR-03, AC-03.2, AC-03.3
**Priority**: P0

**Steps**:
1. Set `state.blast_radius_retries = 3`
2. Call `isBlastRadiusRetryExceeded(state)`
3. Verify returns `true`

**Expected Result**: Returns `true`.

---

### TC-RETRY-04: Allow retry when under limit

**Requirement**: FR-03, AC-03.2
**Priority**: P1

**Steps**:
1. Set `state.blast_radius_retries = 2`
2. Call `isBlastRadiusRetryExceeded(state)`
3. Verify returns `false`

**Expected Result**: Returns `false`.

---

### TC-RETRY-05: State logging includes unaddressed file count

**Requirement**: FR-03, AC-03.4, NFR-03
**Priority**: P1

**Steps**:
1. Call `logBlastRadiusRetry(state, { iteration: 1, unaddressed_count: 3, matched_tasks: 2 })`
2. Verify state.json has a `blast_radius_retry_log` array with the entry

**Expected Result**: Log entry contains iteration number, unaddressed count, matched task count, and timestamp.
