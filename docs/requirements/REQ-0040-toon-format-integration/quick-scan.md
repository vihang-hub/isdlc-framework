# Quick Scan: TOON Format Integration

**Generated**: 2026-02-25T20:30:00Z
**Feature**: Adopt Token-Oriented Object Notation (TOON) for agent prompts and state data to reduce token usage in context management
**Phase**: 00-quick-scan
**Artifact Folder**: REQ-0040-toon-format-integration

---

## Scope Estimate

**Estimated Scope**: Medium
**File Count Estimate**: ~16 files
**Confidence**: High

**Rationale**: TOON integration touches three distinct areas (skills-manifest encoding, state.json array optimization, and session cache formatting). While the changes are localized to specific modules, they affect multiple phases of the workflow and require updates across hooks, utilities, and tests.

---

## Keyword Matches

### Domain Keywords

| Keyword | File Matches | Context |
|---------|--------------|---------|
| skills-manifest | 25 files | Core config file referenced in manifest loading, skill injection, tests |
| skill_lookup | 25 files | Primary target for TOON encoding (243 entries, 7,900 chars) |
| workflow_history | 8 files | State array target (~105K chars, 93.8% of state.json is arrays) |
| skill_usage_log | 8 files | Logging hooks and state tracking |
| session-cache | 7 files | Cache injection, session management, optimization |
| rebuild-cache | 4 files | Cache rebuild logic in bin/, hooks |

### Technical Keywords

| Keyword | File Matches | Context |
|---------|--------------|---------|
| inject-session-cache | 7 files | Session cache hook (primary encoding location) |
| SKILL_INDEX | 5 files | In-memory session cache section (~4,500 tokens) |
| SKILLS_MANIFEST | 5 files | Session cache manifest section (~5,000 tokens) |
| ITERATION_REQUIREMENTS | 5 files | Session cache config section (~5,500 tokens) |
| WORKFLOW_CONFIG | 3 files | Session cache workflow section (~3,500 tokens) |
| JSON serialization | Multiple | Current encoding mechanism to be optimized |

---

## Affected Modules

### Core Data Structures

**skills-manifest.json** (config)
- Files: `/src/claude/hooks/config/skills-manifest.json`
- Size: ~7,900 chars (skill_lookup), ~6,253 chars (ownership)
- Impact: Primary TOON target for tabular data encoding
- Read by: 25 files across hooks, loaders, validators

**state.json** (runtime state)
- Affected sections:
  - `workflow_history` (~105K chars)
  - `skill_usage_log` (~9K chars)
  - `history` (~10K chars)
- Files that touch state: 8+ files for reads/writes
- Impact: High (93.8% of state.json is array-based)

**session-cache.md** (runtime cache)
- Files: `/.isdlc/session-cache.md`
- Sections: SKILL_INDEX, SKILLS_MANIFEST, ITERATION_REQUIREMENTS, WORKFLOW_CONFIG
- Combined tokens: ~18,500 in session cache (~35% reduction target)
- Generated by: `/src/claude/hooks/inject-session-cache.cjs`

### Implementation Modules

| Module | File Path | Purpose | Likely Changes |
|--------|-----------|---------|-----------------|
| Session Cache Injection | `src/claude/hooks/inject-session-cache.cjs` | Builds session cache blocks | TOON encoding for tabular sections |
| Session Cache Builder | Tests in `test-inject-session-cache.test.cjs` | Validates cache generation | Tests for TOON output format |
| Common Utilities | `src/claude/hooks/lib/common.cjs` | Shared serialization | TOON encoder/decoder helpers |
| Cache Rebuild | `bin/rebuild-cache.js` | Rebuilds cache on demand | TOON encoding integration |
| Skill Injection | `src/claude/hooks/tests/skill-injection.test.cjs` | Validates skill data | TOON format validation |
| Installer/Updater | `lib/installer.js`, `lib/updater.js` | System setup | Cache invalidation logic |
| Log Skill Usage | `src/claude/hooks/log-skill-usage.cjs` | Logs usage to state | TOON array writing |

### Test Coverage Areas

**Direct Test Impact** (test files that will need updates):
- `src/claude/hooks/tests/test-inject-session-cache.test.cjs` (session cache format)
- `src/claude/hooks/tests/test-session-cache-builder.test.cjs` (builder logic)
- `src/claude/hooks/tests/test-log-skill-usage.test.cjs` (skill logging)
- `src/claude/hooks/tests/test-io-optimization.test.cjs` (token metrics)
- `lib/cross-validation-verifier.test.js` (state validation)

**Indirect Test Impact** (tests that validate structures containing TOON data):
- All hooks tests that reference session cache sections
- State validation tests
- Skill injection integration tests

---

## Discovery Report Context

From `docs/project-discovery-report.md`:

**Tech Stack**: Node.js 24.4.0, ESM + CJS boundary at hook layer
**Key Systems**:
- Hook system (5 dispatchers, 21 hooks, 26 total hooks including standalones)
- Session cache for context injection (~18,500 tokens)
- State management (workflow_history, skill_usage_log, history arrays)
- Skills manifest (240 skills, tabular lookup structure)

**Identified Optimization Opportunities**:
- Session cache token reduction (~35% target)
- State.json array compression (50-60% reduction)
- Skill lookup encoding (100% tabular eligibility)

---

## Notes for Requirements Phase

The following questions will help clarify scope during Phase 01:

1. **TOON SDK Integration**: Should we use the TypeScript SDK (github.com/toon-format/toon) or implement a minimal encoder/decoder for the specific TOON patterns we need (header+rows)?

2. **Backwards Compatibility**: Do we need to support reading/writing both JSON and TOON formats during transition, or is a full cutover acceptable (requires no active workflows at migration time)?

3. **Fallback Strategy**: Should invalid TOON data fall back to JSON parsing, or should TOON decoding failures propagate as errors?

4. **Coverage Priority**: Should Phase 02 analysis prioritize session cache sections first (immediate token reduction) or state.json arrays first (larger compression ratio)?

5. **Schema Validation**: Do TOON-encoded arrays need JSON Schema validation, or should we validate the decoded representation?

6. **Performance Baseline**: Should we establish encoding/decoding performance benchmarks before implementation to ensure TOON compression doesn't increase hook latency?

---

## File Scope Summary

| Category | Count | Details |
|----------|-------|---------|
| Core configuration files | 1 | skills-manifest.json |
| Runtime state files | 1 | state.json (runtime, gitignored) |
| Session cache files | 1 | session-cache.md (runtime, gitignored) |
| Hook implementation files | 2 | inject-session-cache.cjs, log-skill-usage.cjs |
| Utility/library files | 3 | common.cjs, installer.js, updater.js |
| Cache rebuild tools | 2 | rebuild-cache.js (bin/), rebuild logic |
| Test files (direct impact) | 5 | Session cache, skill logging, IO optimization tests |
| Test files (indirect impact) | 10+ | Integration, validation, hook dispatcher tests |
| **Total Estimated** | **~16** | Focus on core + primary test coverage |

---

## Quick Scan Metadata

```json
{
  "scan_completed_at": "2026-02-25T20:30:00Z",
  "search_duration_ms": 45000,
  "keywords_searched": 12,
  "files_matched": 82,
  "files_analyzed": 16,
  "scope_estimate": "medium",
  "confidence": "high",
  "keyword_sources": [
    "skills-manifest.json (primary config target)",
    "state.json arrays (workflow_history, skill_usage_log, history)",
    "session-cache.md (SKILL_INDEX, SKILLS_MANIFEST sections)",
    "inject-session-cache.cjs (encoding entry point)",
    "Hook system tests (validation layer)"
  ],
  "next_phase": "01-requirements",
  "phase_gate": "GATE-00-QUICK-SCAN"
}
```

---

## Estimation Confidence Rationale

**High Confidence** because:
1. Feature scope is well-defined (TOON encoding for specific data structures)
2. Affected modules are clearly identified (skills-manifest, state.json, session-cache)
3. TOON integration is localized (encoding/decoding utilities + hook modifications)
4. Test surface area is bounded (session cache + skill logging tests)
5. No cross-system dependencies beyond hook injection layer

**Medium scope** because:
1. Changes span 3 distinct functional areas (config, state, cache)
2. Session cache is a critical path (affects every agent run)
3. Multiple test layers need validation (unit + integration)
4. Backwards compatibility strategy TBD (may affect implementation complexity)
