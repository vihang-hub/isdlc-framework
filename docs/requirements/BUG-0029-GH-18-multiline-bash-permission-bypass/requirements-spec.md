# Requirements Specification: BUG-0029-GH-18

**Bug ID:** BUG-0029-GH-18
**Title:** Framework agents generate multiline Bash commands that bypass permission auto-allow rules
**Severity:** Medium
**Scope:** Bug fix
**External Link:** https://github.com/vihangshah/isdlc/issues/18
**Date:** 2026-02-18

---

## 1. Bug Report

### 1.1 Problem Statement

Framework agent prompts (`.md` files in `src/claude/agents/` and `src/claude/commands/`) contain multiline inline Bash code blocks that Claude Code's LLM interprets as executable patterns. When the agent generates a Bash tool call containing newlines, Claude Code's permission system fails to match it against auto-allow rules in `.claude/settings.json`.

Claude Code's `*` glob in permission patterns (e.g., `Bash(grep *)`, `Bash(node *)`) matches any characters **except newlines**. A multiline command like:

```
for f in $(find src -name '*.md'); do
  grep -l 'owned_skills' "$f"
done
```

...does not match `Bash(for *)` or `Bash(grep *)` because the glob cannot span the newline boundaries. The result is that **every multiline Bash command triggers a user permission prompt**, even when every individual command within it (`find`, `grep`, `cat`) is auto-allowed.

### 1.2 Reproduction Steps

1. Install iSDLC framework with default `settings.json` (130+ auto-allow Bash rules).
2. Start a workflow that invokes the software-developer agent (Phase 05) or integration-tester agent (Phase 06).
3. The agent reads its prompt, which contains multiline `bash` code blocks as examples.
4. The agent generates a multiline Bash tool call (e.g., a `for` loop iterating over files).
5. Claude Code presents a permission prompt to the user, blocking autonomous execution.
6. The user must manually approve, defeating the purpose of the auto-allow configuration.

### 1.3 Expected Behavior

All Bash commands generated by framework agents should be auto-allowed by Claude Code's permission rules without user interaction, provided the individual commands within them are already on the auto-allow list.

### 1.4 Actual Behavior

Multiline Bash commands always trigger permission prompts because the `*` glob in settings.json does not match newline characters.

### 1.5 Affected Files (from Phase 00 Quick Scan)

| File | Multiline Blocks | Pattern Types |
|------|-----------------|---------------|
| `src/claude/agents/05-software-developer.md` | 5 | piped-commands, comments-interleaved |
| `src/claude/agents/06-integration-tester.md` | 5 | for-loops, piped-commands |
| `src/claude/commands/discover.md` | 1 | multiline example |
| `src/claude/commands/provider.md` | 13 | multiline examples, piped-commands |
| `src/claude/commands/isdlc.md` | 1 | multiline example |
| **Total** | **25** | |

### 1.6 Root Cause

Agent prompt files contain multiline Bash code blocks as examples and instructions. Claude Code's LLM uses these as patterns when generating Bash tool calls. When the LLM produces a multiline command, the permission matcher's `*` glob (which excludes `\n`) cannot match it, causing a fallback to the interactive permission prompt.

---

## 2. Functional Requirements

### FR-001: Eliminate multiline Bash from agent prompts

**Description:** Agent prompt files (`src/claude/agents/*.md` and `src/claude/commands/*.md`) MUST NOT contain multiline inline Bash code blocks that the LLM could reproduce as executable Bash tool calls.

**Rationale:** Multiline Bash in prompt files teaches the LLM to generate multiline commands, which bypass permission auto-allow rules and interrupt the user.

**Scope:** All 25 multiline Bash blocks across the 5 affected files identified in Phase 00.

#### Acceptance Criteria

**AC-001-01: All multiline Bash blocks rewritten to single-line equivalents**
- Given an agent prompt file containing a multiline Bash code block
- When the file is reviewed after the fix
- Then every Bash code block in the file MUST either be a single-line command, a single-line command chain using `&&` or `;`, or a reference to an executable script file

**AC-001-02: No functional regression in agent behavior**
- Given an agent that previously used multiline Bash examples for its workflow
- When the agent executes after the fix with the rewritten single-line equivalents
- Then the agent MUST produce functionally equivalent results (same files found, same data extracted, same state transitions)

**AC-001-03: for-loop patterns replaced with pipeline equivalents**
- Given a multiline `for`/`do`/`done` loop in an agent prompt
- When replaced with a single-line equivalent
- Then the replacement MUST use `find | xargs`, `grep -r`, or similar pipeline commands that achieve the same result on one line

**AC-001-04: Comment-interleaved blocks restructured**
- Given a multiline Bash block where comment lines (`# ...`) are interleaved between commands
- When the block is rewritten
- Then comments MUST be placed outside/above the code block (as markdown prose), and the code block itself MUST contain only the executable single-line command(s)

---

### FR-002: Add single-line Bash convention to CLAUDE.md

**Description:** Add a shared protocol section to `CLAUDE.md` (under "Agent Framework Context") that establishes a project-wide convention prohibiting multiline inline Bash and specifying single-line alternatives.

**Rationale:** A documented convention prevents regression. New agent files and prompt edits will follow the established pattern. All agents reference CLAUDE.md, so a shared section provides universal coverage.

**Scope:** One new section in `CLAUDE.md`, referenced by all agents via the standard one-line reference pattern.

#### Acceptance Criteria

**AC-002-01: Convention section exists in CLAUDE.md**
- Given the project's `CLAUDE.md` file
- When read after the fix
- Then it MUST contain a new section under "Agent Framework Context" titled "Single-Line Bash Convention" (or equivalent) that:
  - States the rule: agent prompts must use single-line Bash commands
  - Explains why: Claude Code's `*` glob does not match newlines
  - Provides transformation examples (for-loop to pipeline, multiline to `&&` chain)
  - Specifies the escape hatch: extract to `bin/` script files for genuinely complex operations

**AC-002-02: Convention is referenceable by agents**
- Given any agent prompt file that needs to reference the Bash convention
- When the agent includes a one-line reference
- Then the reference format MUST follow the existing pattern: `> See **Single-Line Bash Convention** in CLAUDE.md.`

**AC-002-03: Convention covers all observed pattern types**
- Given the pattern types identified in Phase 00 (for-loops, piped-commands, if-statements, node-e)
- When the convention section is read
- Then it MUST provide a single-line transformation example for each pattern type

---

### FR-003: Extract complex operations to script files

**Description:** Multi-step operations that cannot be reasonably expressed as single-line commands MUST be extracted to executable script files in `bin/` (or an appropriate scripts directory).

**Rationale:** Some operations (e.g., `node -e` with embedded multi-line JavaScript for state transitions) are too complex for single-line rewriting. Extracting them to script files makes the Bash call a simple `node bin/script-name.js --args`, which matches auto-allow rules.

**Scope:** At minimum, the `node -e` pattern identified in `05-software-developer.md`. Additional extractions as needed for blocks that cannot be cleanly single-lined.

#### Acceptance Criteria

**AC-003-01: Complex operations use script files**
- Given a multiline Bash block containing `node -e` with embedded JavaScript (or similarly complex inline scripts)
- When the block is rewritten
- Then it MUST be replaced with a call to an executable script file (e.g., `node bin/update-phase-state.js --phase 02 --status in_progress`)

**AC-003-02: Script files are functional and tested**
- Given a script file extracted from a multiline Bash block
- When the script is executed with valid arguments
- Then it MUST produce the same result as the original inline script

**AC-003-03: Script calls match auto-allow patterns**
- Given a Bash call to an extracted script file
- When Claude Code evaluates it against settings.json auto-allow rules
- Then it MUST match an existing rule (e.g., `Bash(node *)`) without requiring a new permission entry

---

### FR-004: Update CLAUDE.md.template for downstream projects

**Description:** Update `src/claude/CLAUDE.md.template` to include the single-line Bash convention, so that projects initialized with iSDLC inherit the convention automatically.

**Rationale:** The template is the source for new project CLAUDE.md files. Without updating it, new projects will not benefit from the convention and may reintroduce multiline Bash patterns.

**Scope:** One new section added to the template, mirroring the content from FR-002.

#### Acceptance Criteria

**AC-004-01: Template includes Bash convention**
- Given the `src/claude/CLAUDE.md.template` file
- When read after the fix
- Then it MUST contain the same single-line Bash convention section as `CLAUDE.md` (FR-002)

**AC-004-02: Template convention is consistent with CLAUDE.md**
- Given the convention section in both `CLAUDE.md` and `CLAUDE.md.template`
- When compared
- Then the content MUST be identical (or the template MUST reference the section by name with a note to keep in sync)

---

## 3. Non-Functional Requirements

### NFR-001: Zero new permission prompts

| Attribute | Value |
|-----------|-------|
| **ID** | NFR-001 |
| **Category** | Usability |
| **Requirement** | No framework-generated Bash command shall trigger a permission prompt when the individual commands within it are already auto-allowed in settings.json |
| **Metric** | 0 permission prompts during a full feature workflow (phases 01-07) for commands composed of auto-allowed primitives |
| **Measurement Method** | Manual end-to-end workflow test: run a feature workflow and count permission prompts for Bash commands |
| **Priority** | Must Have |

### NFR-002: No functional regression

| Attribute | Value |
|-----------|-------|
| **ID** | NFR-002 |
| **Category** | Reliability |
| **Requirement** | All agent behaviors must remain functionally equivalent after rewriting Bash blocks |
| **Metric** | 100% behavioral equivalence -- agents produce the same outputs (files found, data extracted, state transitions) as before the fix |
| **Measurement Method** | Comparison testing: run affected agents before and after fix, diff outputs |
| **Priority** | Must Have |

### NFR-003: Convention enforceability

| Attribute | Value |
|-----------|-------|
| **ID** | NFR-003 |
| **Category** | Maintainability |
| **Requirement** | The single-line Bash convention must be documentable, discoverable, and reviewable so that future agent changes do not regress |
| **Metric** | Convention documented in CLAUDE.md (referenceable section), present in CLAUDE.md.template, and identifiable in code review (multiline Bash blocks in agent .md files are a review flag) |
| **Measurement Method** | Presence check: verify section exists in both files; review checklist item for PRs modifying agent .md files |
| **Priority** | Should Have |

### NFR-004: Minimal change surface

| Attribute | Value |
|-----------|-------|
| **ID** | NFR-004 |
| **Category** | Maintainability |
| **Requirement** | The fix must minimize changes to unrelated functionality. Only Bash code blocks and their surrounding documentation prose should change. Agent logic, phase flow, and skill declarations must remain untouched. |
| **Metric** | Changes limited to: (a) Bash code blocks within affected files, (b) surrounding prose/comments, (c) new convention section in CLAUDE.md/template, (d) any extracted script files in bin/ |
| **Measurement Method** | Git diff review: verify no changes to agent frontmatter, phase gate criteria, skill declarations, or workflow logic |
| **Priority** | Must Have |

---

## 4. Constraints

### CON-001: Claude Code permission system is immutable

The `*` glob behavior in Claude Code's permission matching is a platform constraint. The fix MUST work within the existing glob semantics -- we cannot change how Claude Code matches permissions. The only lever is ensuring agents generate single-line commands.

### CON-002: Settings.json auto-allow list is the baseline

The existing auto-allow rules in `settings.json` (130+ patterns like `Bash(grep *)`, `Bash(node *)`, `Bash(find *)`) define what commands should work without prompts. The fix must ensure agent-generated commands match these existing patterns. No new allow-list entries should be required.

### CON-003: Agent prompt files are the source of truth

Agent behavior is primarily guided by their `.md` prompt files. The Bash patterns in these files serve as both documentation (showing the user/developer what the agent does) and instruction (the LLM mimics patterns it sees). Changes must preserve the documentation value while eliminating the multiline execution risk.

### CON-004: Backward compatibility with existing workflows

Active workflows that were started before this fix should not break. The fix changes prompt patterns, not runtime state or workflow logic.

---

## 5. Assumptions

- **ASM-001:** Claude Code's LLM tends to reproduce Bash patterns from agent prompt files. Removing multiline patterns from prompts will reduce (likely eliminate) multiline Bash generation during agent execution.
- **ASM-002:** All multiline Bash blocks in the affected files can be expressed as functionally equivalent single-line commands or script file calls.
- **ASM-003:** The 5 files identified in Phase 00 are the complete set of affected files. No additional agent or command files contain problematic multiline Bash blocks.

---

## 6. Out of Scope

- **Changing Claude Code's permission matching behavior.** This is a platform-level concern outside this project's control.
- **Adding new auto-allow rules to settings.json.** The fix should work with the existing rule set.
- **Rewriting non-Bash code blocks** (JSON, TypeScript, YAML examples in agent files). Only Bash blocks that could be executed as Bash tool calls are in scope.
- **Automated enforcement** (e.g., a lint rule or hook that detects multiline Bash in .md files). This is a nice-to-have for a future enhancement but not required for this bug fix.
- **Agent files not identified in Phase 00.** If other files have multiline Bash, they are separate work items.

---

## 7. Glossary

| Term | Definition |
|------|-----------|
| **Auto-allow** | A permission rule in `.claude/settings.json` that allows a Bash command to execute without user confirmation |
| **Glob pattern** | A wildcard matching pattern where `*` matches any characters except newlines |
| **Permission prompt** | An interactive dialog where Claude Code asks the user to approve a Bash command before executing it |
| **Multiline Bash** | A Bash command that spans multiple lines (contains `\n` newline characters) |
| **Single-line Bash** | A Bash command on one line, possibly using `&&`, `;`, or pipes to chain operations |
| **Agent prompt file** | A Markdown file in `src/claude/agents/` or `src/claude/commands/` that defines an agent's behavior and capabilities |

---

## 8. Traceability Summary

| Requirement | Acceptance Criteria | NFRs | Constraints |
|-------------|-------------------|------|-------------|
| FR-001 | AC-001-01, AC-001-02, AC-001-03, AC-001-04 | NFR-001, NFR-002, NFR-004 | CON-001, CON-002, CON-003 |
| FR-002 | AC-002-01, AC-002-02, AC-002-03 | NFR-003 | CON-003 |
| FR-003 | AC-003-01, AC-003-02, AC-003-03 | NFR-001, NFR-002 | CON-001, CON-002 |
| FR-004 | AC-004-01, AC-004-02 | NFR-003 | CON-003 |
