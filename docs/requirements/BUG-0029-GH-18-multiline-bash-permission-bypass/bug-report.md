# Bug Report: BUG-0029-GH-18

**Bug ID:** BUG-0029-GH-18
**External Link:** https://github.com/iSDLC/isdlc/issues/18
**External ID:** GH-18
**Severity:** Medium
**Filed:** 2026-02-19

---

## Summary

Framework agents generate multiline Bash commands (for/do/done loops, `node -e "..."` with embedded JS, heredocs) that bypass Claude Code's permission auto-allow rules. The `*` glob in allowlist patterns (e.g., `Bash(node *)`) does not match newline characters, causing these commands to always prompt for manual permission even when the individual commands within them are auto-allowed.

## Expected Behavior

When agents execute Bash commands that consist of individually auto-allowed operations (grep, node, cat, git, find, etc.), the commands should execute without prompting the user for permission. The framework should be invisible -- users should not be interrupted by permission dialogs during automated workflow processing.

## Actual Behavior

Multiline Bash commands generated by agents always prompt for manual permission because Claude Code's `*` glob in allowlist patterns does not match newline characters. This creates the following user experience degradation:

1. During workflow execution (e.g., discover, impact analysis), the user is unexpectedly prompted to approve Bash commands
2. The "invisible framework" design goal is broken -- the user must manually intervene during automated processing
3. Commands that would auto-allow as single-line equivalents require manual approval when formatted as multiline

### Specific Patterns Observed

| Pattern | Example | Why It Fails |
|---------|---------|-------------|
| `for`/`do`/`done` loops | `for f in $(find . -name "*.md"); do grep "pattern" "$f"; done` | `*` in `Bash(grep *)` or `Bash(find *)` won't match the multiline command string |
| `node -e` with multiline JS | `node -e "\nconst fs = require('fs');\n..."` | `*` in `Bash(node *)` won't match across newlines |
| Heredocs | `cat <<EOF\n...\nEOF` | `*` in `Bash(cat *)` won't match across newlines |
| Multiline `&&` chains | Long chains that wrap across lines | May or may not match depending on Claude Code's internal handling |
| Pipe chains with line breaks | `find . -name "*.md" |\n  xargs grep "pattern"` | `*` won't match newlines in the pipe chain |

### Root Cause

Claude Code's permission system matches Bash tool invocations against `settings.json` allowlist patterns. The `*` glob matches any character sequence EXCEPT newlines. When an agent generates a Bash command containing newlines (multiline formatting), the command string fails to match any allowlist pattern, even though each individual sub-command would match independently.

## Reproduction Steps

1. Set up an iSDLC project with auto-allow rules configured in `.claude/settings.json` (the standard settings include `Bash(node *)`, `Bash(grep *)`, `Bash(find *)`, etc.)
2. Run a workflow that triggers an agent to execute a multiline Bash command -- for example:
   - Run `/discover` which triggers discover agents that may scan files using `for`/`do`/`done` loops
   - Run `/isdlc feature` which triggers state updates that may use multiline `node -e` scripts
3. Observe that Claude Code prompts the user for permission even though the individual commands are in the allowlist
4. Compare with a single-line equivalent of the same command -- the single-line version auto-allows correctly

## Environment

- Platform: macOS / Linux / Windows (all platforms affected)
- Claude Code: Any version with `*` glob-based permission matching
- iSDLC Framework: 0.1.0-alpha
- Node.js: 20+

## Fix Requirement

The fix must ensure that all Bash commands generated by framework agents match Claude Code's auto-allow patterns, eliminating unexpected permission prompts during workflow execution. This requires:

1. **Rewrite multiline Bash commands** across all agent files and command files to use single-line equivalents
2. **Extract complex logic** that cannot be single-lined into standalone script files invokable as `node path/to/script.js`
3. **Add a shared protocol** to CLAUDE.md establishing a single-line Bash convention for all agents
4. **Validate** that after rewrites, all agent-generated Bash commands match existing allowlist patterns

## Related Issues

- BUG-0028-GH-17: Phase B re-runs Phase 00/01 (also had multiline `node -e` state updates -- now resolved but patterns may still exist)
- BACKLOG item 14.3: Original tracking item with fix approach details
