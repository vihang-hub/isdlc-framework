# Test Strategy: REQ-0010 Blast Radius Coverage Validation

**Version**: 1.0.0
**Date**: 2026-02-12
**Phase**: 05-test-strategy
**Status**: Approved
**Traces to**: All FRs (REQ-001 through REQ-007), All NFRs (NFR-001 through NFR-005), All Constraints (CON-001 through CON-005)

---

## 1. Existing Infrastructure

**Framework**: Node.js built-in `node:test` + `node:assert/strict` (Node 18+)
**Module System**: CommonJS (.cjs) for all hooks and tests
**Test Location**: `src/claude/hooks/tests/*.test.cjs`
**Shared Utilities**: `src/claude/hooks/tests/hook-test-utils.cjs`
**Run Command**: `npm run test:hooks`
**Current Baseline**: 555+ tests (302 ESM + 253+ CJS)

### Conventions (from existing test suite)

| Convention | Detail |
|-----------|--------|
| File naming | `test-{hook-name}.test.cjs` |
| Imports | `{ describe, it, beforeEach, afterEach } = require('node:test')` |
| Assertions | `require('node:assert/strict')` |
| Test isolation | `setupTestEnv(stateOverrides)` returns `testDir` string |
| Cleanup | `cleanupTestEnv()` in afterEach |
| Hook prep | `prepareHook(absolutePath)` copies hook + lib/ to temp dir |
| Hook exec | `runHook(hookPath, input)` returns `Promise<{stdout, stderr, code}>` |
| Dispatcher exec | `prepareDispatcher(filename)` + `runDispatcher(path, input)` |
| State helpers | `writeState(obj)`, `readState()`, `writeConfig(name, content)` |

### Strategy: Extend Existing Patterns

This test strategy **extends** the existing CJS hook test suite. It does NOT introduce new frameworks, tools, or conventions. All tests follow the same patterns established by `test-gate-blocker-extended.test.cjs`, `test-constitution-validator.test.cjs`, and other hook tests.

---

## 2. Test Scope

### 2.1 What Is Being Tested

| Component | Test Type | Priority |
|-----------|----------|----------|
| `blast-radius-validator.cjs` (new hook) | Unit + Integration | P0 |
| `parseImpactAnalysis(content)` | Unit | P0 |
| `parseBlastRadiusCoverage(content)` | Unit | P0 |
| `getModifiedFiles(projectRoot)` | Unit (with mock) | P1 |
| `buildCoverageReport(affected, modified, deferred)` | Unit | P0 |
| `formatBlockMessage(report)` | Unit | P1 |
| `check(ctx)` end-to-end flow | Integration | P0 |
| `pre-task-dispatcher.cjs` integration | Integration | P1 |
| `shouldActivate` guard in dispatcher | Unit | P0 |

### 2.2 What Is NOT Being Tested (Out of Scope)

- Agent markdown changes (REQ-003, REQ-004) -- validated by code review, not automated tests
- `blast-radius-coverage.md` artifact generation -- generated by software-developer agent, not by the hook
- Existing hooks (regression handled by existing test suite)
- UI/dashboard visualization (explicitly out of scope per requirements)

---

## 3. Test Types

### 3.1 Unit Tests (Primary Focus)

**Target Coverage**: >= 80% (per Article II, NFR-004)
**File**: `src/claude/hooks/tests/test-blast-radius-validator.test.cjs`

Unit tests exercise each exported function in isolation:

| Function | Test Count | Approach |
|----------|-----------|----------|
| `parseImpactAnalysis()` | 12 | Direct function call with crafted markdown strings |
| `parseBlastRadiusCoverage()` | 8 | Direct function call with crafted markdown strings |
| `getModifiedFiles()` | 4 | Test via `check()` context (requires `execSync` mock or temp git repo) |
| `buildCoverageReport()` | 6 | Direct function call with constructed data structures |
| `formatBlockMessage()` | 3 | Direct function call with report objects |
| `check()` context guards | 8 | Direct function call with partial/invalid ctx objects |

**Estimated Unit Tests**: 41

### 3.2 Integration Tests

**File**: `src/claude/hooks/tests/test-blast-radius-validator.test.cjs` (same file, separate `describe` block)

Integration tests exercise the `check()` function end-to-end with realistic file system state:

| Scenario | Test Count | Approach |
|----------|-----------|----------|
| Full allow flow (all files covered) | 2 | `setupTestEnv` + write impact-analysis.md + mock git state |
| Full block flow (unaddressed files) | 2 | `setupTestEnv` + write impact-analysis.md + partial git state |
| Graceful degradation (missing files) | 4 | Various missing artifact scenarios |
| Deferred file flow | 2 | Write both impact-analysis.md and blast-radius-coverage.md |

**Estimated Integration Tests**: 10

### 3.3 Dispatcher Integration Tests

**File**: `src/claude/hooks/tests/test-blast-radius-validator.test.cjs` (separate `describe` block)

Test that the hook integrates correctly into the `pre-task-dispatcher.cjs`:

| Scenario | Test Count | Approach |
|----------|-----------|----------|
| `shouldActivate` returns true for feature + Phase 06 | 1 | prepareDispatcher + runDispatcher |
| `shouldActivate` returns false for fix workflow | 1 | prepareDispatcher + runDispatcher |
| `shouldActivate` returns false for non-Phase-06 | 1 | prepareDispatcher + runDispatcher |
| `shouldActivate` returns false for no workflow | 1 | prepareDispatcher + runDispatcher |

**Estimated Dispatcher Tests**: 4

### 3.4 Edge Case Tests

Derived from validation-rules.json edge cases (EC-01 through EC-08):

| Edge Case | Test ID | Description |
|-----------|---------|-------------|
| EC-01 | All NO CHANGE entries | Parser returns empty array, hook allows |
| EC-02 | Malformed rows (no backticks) | Rows skipped, empty list, hook allows |
| EC-03 | Empty git diff (no changes) | All files unaddressed, hook blocks |
| EC-04 | Coverage file with no deferrals | Only git diff determines coverage |
| EC-05 | Deferred with empty notes | Not counted as valid deferral |
| EC-06 | Extra files in git diff | Ignored (only impact-analysis files tracked) |
| EC-07 | Special chars in artifact folder | path.join handles correctly |
| EC-08 | Large impact-analysis.md | Performance within budget |

**Estimated Edge Case Tests**: 8

### 3.5 Error Path Tests

Derived from error-taxonomy.md (E-SKIP, E-DEGRADE, E-PARSE, E-GIT, E-IO, E-UNCAUGHT):

| Error Code | Test Approach |
|-----------|---------------|
| E-SKIP-04, E-SKIP-05 | Call `check()` with missing `ctx.input` or `ctx.state` |
| E-DEGRADE-01 | Active workflow with no `artifact_folder` |
| E-DEGRADE-02 | Artifact folder exists but no impact-analysis.md |
| E-DEGRADE-03 | impact-analysis.md with no matching table rows |
| E-PARSE-01 | `parseImpactAnalysis(null)` and `parseImpactAnalysis(123)` |
| E-GIT-01..04 | Covered via integration tests with temp dirs (no git init) |
| E-IO-01 | Permission denied on impact-analysis.md (platform-dependent, lower priority) |
| E-UNCAUGHT-01 | Inject error-inducing state to trigger top-level catch |

**Estimated Error Path Tests**: 10

### 3.6 Security Tests

| Test | Description | Traces to |
|------|-------------|-----------|
| Path traversal in file paths | Ensure backtick content like `../../etc/passwd` is treated as literal path | Article III |
| Malicious markdown injection | Ensure markdown with script tags or code injection is harmless (regex-only parser) | Article III |
| State not modified | Verify `stateModified` is always `false` | CON-003 |

**Estimated Security Tests**: 3

### 3.7 Performance Tests

| Test | Description | Threshold | Traces to |
|------|-------------|-----------|-----------|
| Parser performance | parseImpactAnalysis with 100+ rows completes < 50ms | 50ms | NFR-001 |
| Overall hook latency | Full check() with file I/O completes < 2000ms | 2000ms | NFR-001 |

**Estimated Performance Tests**: 2 (covered within unit tests using timing assertions)

---

## 4. Test Architecture

### 4.1 Test File Structure

```
src/claude/hooks/tests/
  test-blast-radius-validator.test.cjs    <-- NEW (all tests for this hook)
```

A single test file following the established convention. Tests are organized into `describe` blocks:

```
describe('blast-radius-validator.cjs')
  describe('parseImpactAnalysis()')         -- 12 unit tests
  describe('parseBlastRadiusCoverage()')    -- 8 unit tests
  describe('buildCoverageReport()')         -- 6 unit tests
  describe('formatBlockMessage()')          -- 3 unit tests
  describe('check() - context guards')      -- 8 unit tests
  describe('check() - integration')         -- 10 integration tests
  describe('check() - error paths')         -- 10 error path tests
  describe('check() - edge cases')          -- 8 edge case tests
  describe('check() - security')            -- 3 security tests
  describe('dispatcher integration')        -- 4 dispatcher tests
```

### 4.2 Test Execution Strategy

**Direct require() for unit tests**: The hook exports internal functions (`parseImpactAnalysis`, `parseBlastRadiusCoverage`, `getModifiedFiles`, `buildCoverageReport`, `formatBlockMessage`) for direct unit testing. Tests require the hook module directly.

**setupTestEnv() for integration tests**: Integration tests use the hook-test-utils to create isolated temp directories with controlled state.json, impact-analysis.md, and blast-radius-coverage.md files.

**prepareHook() for process-level tests**: Some tests run the hook as a child process via `runHook()` to validate the standalone execution path and ensure the complete module loading + error handling works correctly.

### 4.3 Git Diff Mocking Strategy

The `getModifiedFiles()` function calls `execSync('git diff --name-only main...HEAD')`. For unit tests, we use two approaches:

1. **Direct function bypass**: For `check()` unit tests, we test `buildCoverageReport()` directly with constructed `Set<string>` objects, bypassing `getModifiedFiles()`.

2. **Temp git repos**: For integration tests that need the full flow, we create a temporary git repository with controlled state:
   ```javascript
   // In beforeEach for integration tests:
   execSync('git init', { cwd: testDir });
   execSync('git checkout -b main', { cwd: testDir });
   execSync('git commit --allow-empty -m "init"', { cwd: testDir });
   execSync('git checkout -b feature', { cwd: testDir });
   // Write and commit files to simulate modified state
   ```

3. **Fail-open verification**: For git failure scenarios, use a temp directory without `git init` -- execSync will fail, hook returns `allow`.

---

## 5. Coverage Targets

| Metric | Target | Rationale |
|--------|--------|-----------|
| Unit test coverage | >= 80% | Article II threshold |
| Function coverage | 100% | All 6 exported functions tested |
| Branch coverage | >= 80% | All decision paths exercised |
| Error path coverage | 100% | All 15 error codes from error-taxonomy.md |
| Edge case coverage | 100% | All 8 edge cases from validation-rules.json |
| AC coverage | 100% | All 32 acceptance criteria mapped to tests |
| Regression threshold | Tests >= baseline | Article II regression threshold |

---

## 6. Test Data Plan

See detailed test data plan in the test cases document. Summary:

| Data Category | Examples |
|---------------|---------|
| Valid impact-analysis.md | Single table, multi-table, mixed change types |
| Invalid impact-analysis.md | Empty, null, no tables, malformed rows |
| Valid blast-radius-coverage.md | Covered entries, deferred with rationale |
| Invalid blast-radius-coverage.md | Missing notes, wrong status, empty |
| State objects | Feature workflow, fix workflow, no workflow, missing fields |
| Git diff outputs | Full coverage, partial, empty, error |

---

## 7. Test Commands

All tests run using existing infrastructure:

```bash
# Run all hook tests (including new blast-radius-validator tests)
npm run test:hooks

# Run only blast-radius-validator tests
node --test src/claude/hooks/tests/test-blast-radius-validator.test.cjs

# Run all tests (ESM + CJS)
npm run test:all
```

---

## 8. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Git diff mock complexity | Medium | Medium | Use direct function testing + temp git repos |
| Cross-platform path differences | Low | Medium | All paths use forward slashes (git convention) |
| Regex parser edge cases | Medium | Low | Extensive edge case tests from validation-rules.json |
| Performance flakiness | Low | Low | Generous timing thresholds (2x expected) |
| Dispatcher integration conflicts | Low | High | Run full dispatcher test suite after changes |

---

## 9. Traceability Summary

| Requirement Type | Count | Tests Mapped |
|-----------------|-------|-------------|
| Functional (REQ-001..007) | 7 | All 7 mapped |
| Acceptance Criteria | 32 | All 32 mapped |
| Non-Functional (NFR-001..005) | 5 | All 5 mapped |
| Constraints (CON-001..005) | 5 | All 5 mapped |
| Error Codes (15) | 15 | All 15 mapped |
| Edge Cases (8) | 8 | All 8 mapped |

Total estimated test cases: **78**

See `traceability-matrix.csv` for the complete mapping.
