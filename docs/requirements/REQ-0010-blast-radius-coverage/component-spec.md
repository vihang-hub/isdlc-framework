# Component Specification: Dispatcher Integration & Agent Updates

**Version**: 1.0.0
**Date**: 2026-02-12
**Phase**: 04-design
**Traces to**: REQ-007 (dispatcher integration), REQ-003 (checklist generation), REQ-004 (agent integration)

---

## 1. pre-task-dispatcher.cjs Integration

### 1.1 Interface Contract

The blast-radius-validator integrates with `pre-task-dispatcher.cjs` as the 9th entry in the HOOKS array, following the identical pattern used by all 8 existing hooks.

**File**: `src/claude/hooks/dispatchers/pre-task-dispatcher.cjs`
**Change Type**: MODIFY (additive only -- 5-8 lines)
**Traces to**: REQ-007 AC-007-03, ADR-0005

### 1.2 New Import

```javascript
// Add after line 50 (after test-adequacy-blocker import):
const { check: blastRadiusValidatorCheck } = require('../blast-radius-validator.cjs');
```

**Pattern Match**: Identical to all other hook imports in the dispatcher (destructured `check` with renamed alias).

### 1.3 New HOOKS Array Entry

```javascript
// Add as position 9 in HOOKS array (after test-adequacy-blocker, line ~73):
{
    name: 'blast-radius-validator',
    check: blastRadiusValidatorCheck,
    shouldActivate: (ctx) => {
        // Condition 1: Active feature workflow exists (CON-005)
        if (!ctx.state?.active_workflow) return false;
        if (ctx.state.active_workflow.type !== 'feature') return false;
        // Condition 2: Phase 06 implementation
        const phase = ctx.state.active_workflow.current_phase || '';
        return phase === '06-implementation';
    }
}
```

**shouldActivate Guard Design** (REQ-007 AC-007-02):

| Condition | Check | False -> | Traces to |
|-----------|-------|----------|-----------|
| Active workflow exists | `ctx.state?.active_workflow` | Skip (no workflow context) | AC-002-03 |
| Feature workflow type | `active_workflow.type !== 'feature'` | Skip (fix/upgrade workflows excluded) | CON-005 |
| Phase 06 implementation | `current_phase === '06-implementation'` | Skip (other phases excluded) | AC-001-06 |

**Design Decision**: The `shouldActivate` guard is defined inline in the dispatcher HOOKS array (not inside the hook module). This follows the pattern established by `test-adequacy-blocker` which defines its `shouldActivate` inline checking for upgrade phases. The hook's `check()` function then handles validation logic without re-checking activation conditions.

### 1.4 Dispatcher Integration Points

```
HOOKS array (after modification):
  [0] iteration-corridor     - shouldActivate: hasActiveWorkflow
  [1] skill-validator        - shouldActivate: (none, always runs)
  [2] phase-loop-controller  - shouldActivate: hasActiveWorkflow
  [3] plan-surfacer          - shouldActivate: hasActiveWorkflow
  [4] phase-sequence-guard   - shouldActivate: hasActiveWorkflow
  [5] gate-blocker           - shouldActivate: hasActiveWorkflow
  [6] constitution-validator - shouldActivate: hasActiveWorkflow
  [7] test-adequacy-blocker  - shouldActivate: upgrade phases only
  [8] blast-radius-validator - shouldActivate: feature + Phase 06 only  <-- NEW
```

### 1.5 Execution Flow Within Dispatcher

```
dispatcher main():
  for each hook in HOOKS:
    if hook.shouldActivate && !hook.shouldActivate(ctx) -> continue (skip)
    result = hook.check(ctx)
    if result.stateModified -> stateModified = true
    if result.stderr -> allStderr.push(result.stderr)
    if result.decision === 'block':
      writeState if modified
      output stderr
      outputBlockResponse(result.stopReason)
      exit(0)  // Short-circuit

  // After all hooks: write state if modified, output stderr, exit(0)
```

**Short-Circuit Behavior**: If any hook before blast-radius-validator blocks (e.g., gate-blocker at position 5), the dispatcher exits immediately and blast-radius-validator never runs. This is correct -- blast radius validation only matters when all other gate prerequisites pass (ADR-0005).

### 1.6 Updated File Header

The dispatcher version comment and header should be updated:

```javascript
// Line 6: Update comment to reflect 9 hooks
// Before: "Consolidates 8 PreToolUse[Task] hooks into 1 process for performance."
// After:  "Consolidates 9 PreToolUse[Task] hooks into 1 process for performance."

// Line 18: Add to execution order comment
// +  *   9. blast-radius-validator - impact analysis coverage (feature Phase 06)
```

---

## 2. blast-radius-coverage.md Artifact Specification

### 2.1 Artifact Purpose

Generated by the software-developer agent (Phase 06) after implementation. Documents coverage status of every file identified in impact-analysis.md. Read by the blast-radius-validator hook to identify deferred files.

**File**: `docs/requirements/{artifact_folder}/blast-radius-coverage.md`
**Generator**: software-developer agent (05-software-developer.md)
**Consumer**: blast-radius-validator.cjs hook
**Traces to**: REQ-003 (all ACs), REQ-004 AC-004-04

### 2.2 Artifact Format

```markdown
# Blast Radius Coverage: {artifact_folder}

**Generated**: {ISO 8601 timestamp}
**Phase**: 06-implementation
**Impact Analysis**: impact-analysis.md

## Summary

| Metric | Value |
|--------|-------|
| Total Affected Files | {N} |
| Covered | {N} |
| Deferred | {N} |
| Coverage | {N}% |

## Coverage Checklist

| File Path | Expected Change | Coverage Status | Notes |
|-----------|----------------|-----------------|-------|
| `src/path/to/file.cjs` | CREATE | covered | New file created |
| `src/path/to/other.cjs` | MODIFY | covered | Modified in implementation |
| `src/path/to/skipped.cjs` | MODIFY | deferred | Deferred to REQ-0011: not needed for MVP |
```

### 2.3 Column Definitions

| Column | Type | Description | Traces to |
|--------|------|-------------|-----------|
| File Path | Backtick-wrapped path | Path from impact-analysis.md | AC-003-02 |
| Expected Change | `CREATE` / `MODIFY` / `DELETE` | Change type from impact analysis | AC-003-02 |
| Coverage Status | `covered` / `deferred` / `unaddressed` | Implementation coverage | AC-003-02 |
| Notes | Free text | For `covered`: what change was made. For `deferred`: mandatory rationale | AC-003-03, AC-003-04 |

### 2.4 Summary Metrics (AC-003-05)

| Metric | Calculation |
|--------|-------------|
| Total Affected Files | Count of rows in checklist |
| Covered | Count where status = 'covered' |
| Deferred | Count where status = 'deferred' |
| Coverage | `(covered + deferred) / total * 100`% |

---

## 3. 05-software-developer.md Agent Updates

### 3.1 Change Summary

Two new sections added to `src/claude/agents/05-software-developer.md`. Both are additive -- no existing content is modified (CON-004).

### 3.2 New Section: Blast Radius Acknowledgement (Pre-Implementation)

**Placement**: After existing "PRE-PHASE CHECK" section, before implementation begins.

```markdown
# BLAST RADIUS ACKNOWLEDGEMENT

Before beginning implementation, read the impact analysis to understand the
full scope of changes expected for this feature.

## Steps

1. Read `docs/requirements/{artifact_folder}/impact-analysis.md`
2. Extract the list of affected files and their expected change types
   (CREATE, MODIFY, DELETE). Ignore files marked NO CHANGE.
3. Include a "Blast Radius Acknowledgement" section in your implementation
   plan listing:
   - Each affected file path
   - The expected change type
   - Your planned action (implement, defer with rationale)
4. If impact-analysis.md does not exist, skip this section and proceed
   normally.

## Important

- This acknowledgement is for YOUR planning only -- the blast-radius-validator
  hook will independently verify coverage at gate advancement.
- Every file from impact analysis must be either modified in your
  implementation or explicitly deferred with rationale.
```

**Traces to**: REQ-004 AC-004-01, AC-004-02, AC-004-03

### 3.3 New Section: Blast Radius Coverage Checklist (Post-Implementation)

**Placement**: After implementation is complete, before declaring GATE-06 passed.

```markdown
# BLAST RADIUS COVERAGE CHECKLIST

After implementation is complete (and before declaring GATE-06 passed),
generate a blast-radius-coverage.md artifact documenting the coverage status
of every affected file from impact analysis.

## Steps

1. Re-read `docs/requirements/{artifact_folder}/impact-analysis.md`
2. For each affected file (excluding NO CHANGE):
   a. Check if the file was modified in your implementation (covered)
   b. If not modified, document why (deferred with rationale)
3. Write `docs/requirements/{artifact_folder}/blast-radius-coverage.md`
   with the format:

   | File Path | Expected Change | Coverage Status | Notes |
   |-----------|----------------|-----------------|-------|
   | `path/to/file` | MODIFY | covered | Modified: added X function |
   | `path/to/other` | MODIFY | deferred | Deferred: not needed for MVP |

4. Include a Summary section with total, covered, deferred counts.

## When to Skip

- If impact-analysis.md does not exist for this workflow, skip this step.
- This step only applies to feature workflows (not fix workflows).
```

**Traces to**: REQ-003 AC-003-01 through AC-003-05, REQ-004 AC-004-04

---

## 4. Traceability Matrix

| Component | Requirements | ACs |
|-----------|-------------|-----|
| Dispatcher import + HOOKS entry | REQ-007 | AC-007-01, AC-007-02, AC-007-03 |
| shouldActivate guard (inline) | REQ-007, CON-005 | AC-007-02, AC-001-06 |
| blast-radius-coverage.md format | REQ-003 | AC-003-01 through AC-003-05 |
| Agent: Blast Radius Acknowledgement | REQ-004 | AC-004-01, AC-004-02, AC-004-03 |
| Agent: Blast Radius Coverage Checklist | REQ-003, REQ-004 | AC-003-01 through AC-003-05, AC-004-04 |
