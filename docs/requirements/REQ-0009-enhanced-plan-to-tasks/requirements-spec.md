# Requirements Specification: REQ-0009 Enhanced Plan-to-Tasks Pipeline

**Version**: 1.0.0
**Date**: 2026-02-11
**Author**: Requirements Analyst (Agent 01)
**Status**: DRAFT — Pending user approval via A/R/C menu
**Workflow**: feature
**Artifact Folder**: REQ-0009-enhanced-plan-to-tasks

---

## 1. Overview

### 1.1 Problem Statement

The current `tasks.md` generated by the ORCH-012 generate-plan skill serves as a progress tracker showing phases and high-level task checkboxes. It lacks the specificity needed to serve as an implementation authority. The software-developer agent (Phase 06) currently self-decomposes work rather than following a precise, pre-planned task list tied to specific files, functions, and requirements.

### 1.2 Business Justification

Inspired by Spec-Kit's `/speckit.plan` -> `/speckit.tasks` -> `/speckit.implement` pipeline, this feature transforms tasks.md from a passive tracker into an active implementation contract. This improves:
- **Predictability**: Human and agents can see exactly what will be built before implementation starts
- **Traceability**: Every line of code traces back to a requirement
- **Quality**: Mechanical execution reduces implementation drift from specifications
- **Auditability**: Complete forward/backward traceability chain

### 1.3 Scope

**In Scope:**
- Enhance ORCH-012 generate-plan skill with file-level task output
- Add traceability tags (REQ-NNN, AC-NNN) to all tasks
- Add dependency annotations (blocks/blocked_by) between tasks
- Create a task refinement step that runs after design phase
- Add mechanical execution mode as opt-in for the software-developer agent
- Update PLAN INTEGRATION PROTOCOL across all agents for new format
- Update plan-surfacer hook to validate enhanced format

**Out of Scope:**
- Parallel task execution engine (future enhancement)
- Visual dependency graph rendering (CLI is text-only)
- Automatic task generation from code diffs
- Changes to the A/R/C menu pattern in Phase 01
- Changes to existing workflow phase sequences (no new phases added to workflows.json)

---

## 2. Functional Requirements

### FR-01: File-Level Task Granularity

**Description**: After the design phase completes, tasks.md MUST contain implementation tasks decomposed to the file level. Each implementation-phase task specifies target file paths, functions/exports to create or modify, and expected behavioral changes.

**Acceptance Criteria**:
- AC-01a: Each Phase 06 (Implementation) task in tasks.md specifies at least one target file path
- AC-01b: Each file-level task indicates whether the file is CREATE (new) or MODIFY (existing)
- AC-01c: Each file-level task specifies the functions, exports, or sections to add or change
- AC-01d: File paths use project-relative format (e.g., `src/claude/skills/orchestration/generate-plan/SKILL.md`)
- AC-01e: Tasks for non-implementation phases (01-05, 07-08, 16) retain their current high-level format

### FR-02: User-Story Traceability

**Description**: Every task in tasks.md MUST be tagged with at least one requirement ID (REQ-NNN) and/or acceptance criterion (AC-NNN) that it fulfills.

**Acceptance Criteria**:
- AC-02a: Every task line includes a `traces: [REQ-NNN, AC-NNx]` annotation
- AC-02b: A traceability summary section at the bottom of tasks.md shows requirement coverage (requirements with tasks vs requirements without tasks)
- AC-02c: The generate-plan skill reads requirements-spec.md to extract REQ and AC IDs
- AC-02d: Orphan detection: tasks without traceability tags trigger a validation warning
- AC-02e: Gap detection: requirements/ACs without corresponding tasks trigger a validation warning

### FR-03: Explicit Dependency Graph

**Description**: Tasks MUST declare explicit dependencies using `blocks` and `blocked_by` annotations. The dependency graph MUST be acyclic.

**Acceptance Criteria**:
- AC-03a: Tasks can declare `blocked_by: [TNNNN, ...]` indicating prerequisite tasks
- AC-03b: Tasks can declare `blocks: [TNNNN, ...]` indicating downstream dependents
- AC-03c: The generate-plan skill validates that the dependency graph contains no cycles
- AC-03d: A critical path section in tasks.md identifies the longest dependency chain
- AC-03e: Cross-phase dependencies are supported (e.g., a Phase 05 test design task blocking a Phase 06 implementation task)

### FR-04: Task Refinement Step

**Description**: A dedicated refinement step between design and implementation converts high-level design artifacts into file-level implementation tasks. This step enhances the existing ORCH-012 generate-plan skill.

**Acceptance Criteria**:
- AC-04a: After GATE-04 (Design) passes, the orchestrator invokes a refinement step before Phase 05 (or Phase 06)
- AC-04b: The refinement step reads design artifacts (interface-spec, module-designs, design-specification.md)
- AC-04c: The refinement step updates tasks.md in-place, replacing high-level Phase 06 tasks with file-level tasks
- AC-04d: The refinement step preserves all Phase 01-05 tasks unchanged (no re-generation)
- AC-04e: The refinement step adds traceability tags by cross-referencing requirements-spec.md
- AC-04f: The refinement step adds dependency annotations based on file/module relationships from design
- AC-04g: The refinement produces a `task-refinement-log.md` artifact documenting what was decomposed

### FR-05: Mechanical Execution Mode

**Description**: The software-developer agent MUST support an opt-in mechanical execution mode where it follows tasks.md literally rather than self-decomposing work.

**Acceptance Criteria**:
- AC-05a: A `--mechanical` flag (or `mechanical_mode: true` agent modifier) enables mechanical execution
- AC-05b: In mechanical mode, Agent 05 reads tasks.md and executes tasks in dependency order
- AC-05c: In mechanical mode, Agent 05 does NOT add, remove, or reorder tasks without flagging the deviation
- AC-05d: In mechanical mode, each task completion is immediately marked `[X]` in tasks.md
- AC-05e: If a task cannot be completed as specified, Agent 05 creates a `[BLOCKED]` annotation with reason
- AC-05f: Mechanical mode is OFF by default — standard self-decomposition remains the default behavior
- AC-05g: When mechanical mode is ON but tasks.md lacks file-level granularity, Agent 05 falls back to standard mode with a warning

### FR-06: Enhanced Tasks.md Format

**Description**: The tasks.md format MUST be extended to support all five sub-features while remaining backward compatible with existing PLAN INTEGRATION PROTOCOL parsing.

**Acceptance Criteria**:
- AC-06a: The checkbox format `- [ ] TNNNN` is preserved (backward compatible)
- AC-06b: Traceability tags appear after the task description: `| traces: FR-01, AC-01a`
- AC-06c: Dependency annotations appear on a sub-line: `  blocked_by: [T0001, T0002]`
- AC-06d: File-level details appear on sub-lines: `  files: src/foo/bar.js (MODIFY), src/foo/baz.js (CREATE)`
- AC-06e: A `## Dependency Graph` section shows the critical path
- AC-06f: A `## Traceability Matrix` section shows requirement-to-task coverage
- AC-06g: Existing agents that only check for `[X]`/`[ ]` patterns continue to work unchanged

### FR-07: PLAN INTEGRATION PROTOCOL Update

**Description**: The shared PLAN INTEGRATION PROTOCOL embedded in all phase agents MUST be updated to handle the enhanced format.

**Acceptance Criteria**:
- AC-07a: Agents that only read/update checkboxes are unaffected (backward compatible)
- AC-07b: The software-developer agent's protocol section adds mechanical mode instructions
- AC-07c: The protocol documents the new sub-line format (traces, blocked_by, files)
- AC-07d: The protocol specifies that agents MUST NOT remove traceability or dependency annotations when updating tasks

### FR-08: Plan Surfacer Hook Enhancement

**Description**: The plan-surfacer hook validates that tasks.md exists and optionally validates the enhanced format.

**Acceptance Criteria**:
- AC-08a: The hook continues to block implementation phases when tasks.md is missing (existing behavior preserved)
- AC-08b: The hook optionally validates that file-level tasks exist for Phase 06 sections
- AC-08c: Validation failures are warnings (not blocks) to maintain fail-open behavior

---

## 3. Non-Functional Requirements

### NFR-01: Performance

The task refinement step MUST complete within 60 seconds for projects with up to 100 requirements and 500 design elements. The enhanced tasks.md format MUST not cause measurable latency increase in plan-surfacer hook execution.

### NFR-02: Backward Compatibility

All changes MUST be backward compatible:
- Existing tasks.md files without enhanced annotations MUST continue to work
- Agents that only check `[X]`/`[ ]` patterns MUST NOT break
- The plan-surfacer hook MUST NOT block on missing enhanced annotations
- Workflows that skip design phase (e.g., fix workflow) MUST still generate valid tasks.md

### NFR-03: Maintainability

The enhanced format MUST be documented in a schema reference that is included in the SKILL.md for ORCH-012. All new annotations MUST follow consistent syntax patterns.

### NFR-04: Extensibility

The task format MUST support future extensions (e.g., effort estimates, priority tags) without breaking the current format. Use a pipe-delimited annotation style that can be extended: `| key: value`.

---

## 4. Constraints

### C-01: No New Workflow Phases

The refinement step MUST NOT add a new phase to workflows.json. It operates as an orchestrator-level step between existing phases (similar to how plan generation works after GATE-01).

### C-02: Single File Authority

tasks.md remains a single file (not split into per-phase files). The file grows with the project but is pruned on workflow completion.

### C-03: Module System Compliance

Any new hook code or utility functions MUST follow the existing module system: hooks use CommonJS (.cjs), lib/ uses ESM (.js). Per Article XIII.

### C-04: Test Baseline Preservation

All existing tests (1229+) MUST continue to pass. Per Article II, the test count MUST NOT decrease.

---

## 5. User Stories

See `user-stories.json` for the full set of user stories with acceptance criteria mappings.

---

## 6. Dependencies

| Dependency | Type | Impact |
|------------|------|--------|
| ORCH-012 generate-plan skill | Internal | Primary target for enhancement |
| Plan Surfacer Hook (plan-surfacer.cjs) | Internal | Must validate enhanced format |
| PLAN INTEGRATION PROTOCOL | Internal | Shared across 17 agents |
| Software Developer Agent (Agent 05) | Internal | Mechanical execution mode consumer |
| workflows.json | Config | Constraint: no new phases |
| skills-manifest.json | Config | May need metadata update |

---

## 7. Risks

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Enhanced format breaks existing agents | LOW | HIGH | Backward-compatible design (AC-06g) |
| Task refinement produces incorrect file mappings | MEDIUM | MEDIUM | Validation step + human review at GATE |
| Mechanical mode is too rigid for complex features | MEDIUM | LOW | Opt-in only (AC-05f), fallback to standard (AC-05g) |
| Circular dependencies in generated graph | LOW | MEDIUM | Cycle detection validation (AC-03c) |

---

## 8. Open Questions

None — all five sub-features are well-defined with clear acceptance criteria.

---

## 9. Approval

| Role | Name | Status | Date |
|------|------|--------|------|
| Stakeholder | User | PENDING | |
| Requirements Analyst | Agent 01 | APPROVED | 2026-02-11 |
| Orchestrator | Agent 00 | PENDING | |
